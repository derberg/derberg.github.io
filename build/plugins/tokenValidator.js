!function(f){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=f();else if("function"==typeof define&&define.amd)define([],f);else{var g;g="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this,g.tokenValidatorPlugin=f()}}(function(){return function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a="function"==typeof require&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error("Cannot find module '"+o+"'");throw f.code="MODULE_NOT_FOUND",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e)},l,l.exports,e,t,n,r)}return n[o].exports}for(var i="function"==typeof require&&require,o=0;o<r.length;o++)s(r[o]);return s}({1:[function(require,module,exports){module.exports=function(){"use strict";function init(){if(IDTOKEN=lscache.get("id_token"),!IDTOKEN){var loginFrameUrl=OAUTH_SERVICE_URL+"/authorize?response_type=id_token token&client_id="+CLIENT_ID+"&nonce="+Math.ceil(100*Math.random())+"&display=popup&redirect_uri="+REDIR_URL+"&scope=hybris.no_tenant&hybris_stylesheet_url="+LOGIN_CSS_URL;return $("#loginFrame").attr("src",loginFrameUrl),$("#loginHandlerWrapper").removeClass("u-hide-permanently")}return $("#loginHandlerWrapper").addClass("u-hide-permanently"),CLAIM=getClaim(IDTOKEN),new Date(CLAIM.exp).getTime()<(new Date).getTime()?(lscache.remove("id_token"),$("#loginHandlerWrapper").removeClass("u-hide-permanently")):(lscache.get("login")||lscache.set("login",CLAIM.email),newProjectResilience(checkNoTenantToken),void $("#apiNotebookHandler").on("click",function(){$(".alert-danger").remove(),lscache.get("noTenantToken")?getCredentials():authorize()}))}function getClaim(idToken){var tokenClaim=idToken.split(".")[1],uClaim=b64utos(tokenClaim);return JWS.readSafeJSONString(uClaim)}function getCredentials(){var userToken=lscache.get("noTenantToken");CLAIM=getClaim(IDTOKEN),lscache.set("login",CLAIM.email),$("#newProjectLoader").fadeIn(300),$.ajax({url:YODA_SERVICE_URL+"/application",method:"POST",dataType:"json",headers:{Authorization:"Bearer "+userToken}}).done(function(data,xhr,result){201===result.status&&($("#newProjectLoader").fadeOut(300),$("#newProject .grid-cards__title").html("New Project setup succesfully"),$("#newProject .grid-cards__description").hide(),$("#credentials code").html('<span class="hljs-tag"><strong>ClientId:</strong></span> '+data.clientId+'<br><span class="hljs-tag"><strong>ClientSecret:</strong></span> '+data.clientSecret+'<br><span class="hljs-tag"><strong>AppId:</strong></span> '+data.appId+'<br><span class="hljs-tag"><strong>ProjectId:</strong></span> '+data.projectId+'<br><span class="hljs-tag"><strong>Token:</strong></span> '+data.token),$("#credentials").slideDown(300),$("#apiNotebookInjecter").slideDown(300),$("#newProjectHeader").after('<div style="display:none;" class="alert alert-success alert-dismissible" role="alert"><button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>Generated project will last only for 1h and will be permanently deleted after that time.</div>').next().slideDown(300,sendMessageResizeNeeded),$("#apiNotebookInjecter").on("click",function(){try{window.sessionStorage.setItem("credentials",JSON.stringify(data)),$("#iframeNotebook").contents().find("#credentialsButton").trigger("click"),sendMessageResizeNeeded()}catch(err){}}),$("#apiNotebookHandler").hide())}).fail(function(){$("#newProjectLoader").fadeOut(300),showErrorNewProjectHeader("Project setup was not possible, please try again.")})}function authorize(){var authFrame=document.createElement("iframe");authFrame.setAttribute("id","oauthFrame"),authFrame.setAttribute("style","display: none;position:absolute; top:0px; left:0px;"),document.body.appendChild(authFrame),authFrame.src=OAUTH_SERVICE_URL+"/authorize?response_type=token&client_id="+CLIENT_ID+"&redirect_uri="+REDIR_URL+"&id_token_hint="+lscache.get("id_token")+"&scope=hybris.no_tenant",authFrame.addEventListener("load",function(){var hash,frameContent,frame=document.getElementById("oauthFrame");try{frameContent=frame.contentDocument,hash=frameContent.location.hash,hash||window.parent.postMessage({failed:!0},"*")}catch(e){onGetTokenError()}},!1)}function onGetTokenError(){$("#newProjectLoader").fadeOut(300),showErrorNewProjectHeader("Your access token expired and we failed to renew it, please try again.")}function showErrorNewProjectHeader(msg){$("#newProjectHeader").after('<div style="display:none;" class="alert alert-danger alert-dismissible" role="alert"><button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>'+msg+"</div>").next().slideDown(300)}function sendMessageResizeNeeded(){var event=new CustomEvent("resizeNeeded");window.dispatchEvent(event)}function newProjectResilience(callback){$.ajax({url:YODA_SERVICE_URL+"/checkup",method:"GET"}).done(function(data,xhr,result){200===result.status&&callback()})}function checkNoTenantToken(){lscache.get("noTenantToken")?$("#newProject").removeClass("u-hide-permanently"):authorize()}function receiveMessage(event){var data=event.data;if(data&&data.idToken){$("#loginModal").modal("hide");var frames=window.parent&&window.parent.$(".apinotebookFrame");frames&&frames.length?frames.each(function(){this.contentWindow.initApp(),this.contentWindow.initToken()}):(initApp(),initToken())}data&&data.failed&&onGetTokenError(),data&&data.noTenantToken&&($("#oauthFrame").remove(),newProjectResilience(checkNoTenantToken))}var PLUGIN=({proxy:{url:"/proxy"},envVariables:{yodaLink:"https://api.stage.yaas.io/hybris/yoda/v1",oauthService:"https://api.stage.yaas.io/hybris/oauth2/v1",accountService:"https://api.stage.yaas.io/hybris/account/v1/",marketplaceService:"https://api.stage.yaas.io/hybris/marketplace/v3",clientId:"4lfyAwV3zeskWEIzoIMxohRMVYd0YFXI",url:"http://127.0.0.1:3000/auth.html",loginCssUrl:"https://devportal.stage.yaas.io/styles/auth-iframe.css"},customLocation:{path:"./apinotebooks",devportalUrl:"http://localhost:9778/apinotebooks/",mode:"external"}}||{}).envVariables;if(PLUGIN){var CLAIM,IDTOKEN,YODA_SERVICE_URL=PLUGIN.yodaLink,OAUTH_SERVICE_URL=PLUGIN.oauthService,CLIENT_ID=PLUGIN.clientId,REDIR_URL=PLUGIN.url,LOGIN_CSS_URL=PLUGIN.loginCssUrl,JWS=KJUR.jws.JWS;$("#apiNotebookHandler").ready(init),window.addEventListener("message",receiveMessage,!1),window.initToken=init}}},{}]},{},[1])(1)});